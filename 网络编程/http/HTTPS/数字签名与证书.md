
# 摘要算法
实现完整性的手段主要是**摘要算法**，也就是常说的散列函数（哈希函数Hash Function）

摘要算法是一种特殊的压缩算法，能够把任意长度的数据压缩成*固定长度并且独一无二*的“摘要字符串”，就好像给这段数据生成了一个数字”指纹“

摘要算法实际上是把数据从一个“大空间”映射到了“小空间”，所以就存在“冲突”（collision，也叫碰撞）的可能性。好的摘要算法需要尽量减少冲突。

摘要算法具有“雪崩效应”，输入的微小变化会引起输出的摘要的剧烈变化

## 常用的摘要算法
- MD5（Message-Digest 5）：生成16字节的数字摘要
- SHA-1（Secure Hash Algrithom -1）：生成20字节的数字摘要
以上两者安全性较低，已被TLS禁用
- SHA-2 ： TLS推荐使用的
	SHA-2实际上是一系列摘要算法的统称，总共有6种，常用的有SHA224、SHA256、SHA384，分别能够生成28字节、32字节、48字节的摘要。

# 完整性
摘要算法保证了“数字摘要”和原文是完全等价的（一个摘要对应一个原文）
因此只要在原文后面附上其摘要，就能保证数据的完整性

![[Pasted image 20220625105743.png]]
1. 发送方先计算一下数据的摘要
2. 使用会话密匙加密数据和摘要
3. 接收方收到密文后使用会话密匙解密得到数据加摘要
4. 接收方也计算一下发送过来的数据的摘要并且和发送方发过来的摘要进行比对。如果不同，则说明数据有可能被篡改过
（注意**摘要算法必须和混合加密一起使用**，如果使用明文传输，则黑客可以明文和摘要一起改，那么接收方也无法分辨报文是否被篡改）


# 数字签名
加密算法结合摘要算法，我们的通信过程可以说是比较安全了。但这里还有*漏洞，就是通信的两个端点（endpoint）的身份问题*。

黑客可以伪造成成两个端点中的任何一个。比如伪造成网站向客户窃取信息，或者伪造成客户向网站发送消息，网站没法确认你的身份。

## 数字签名可以解决身份认证和不可否认问题
私匙是每个人自己拥有且独一无二的，因此可以用来证明你的身份

**数字签名 = 私匙 + 摘要算法**

数字签名是把公匙和私匙反过来使用。即使用私匙加密，公匙解密。因为非对称加密效率太低，因此只加密原文的摘要。这样运算量就小的多，而且得到的数字签名也很小，方便保管和传输。

### 使用数字签名进行身份认证的过程
1. 使用摘要算法计算原文的摘要
2. 使用私匙加密摘要获得数字签名
3. 对方使用公匙解密，确认你的身份，计算摘要确保原文未被篡改
![[Pasted image 20220625111412.png]]

数字签名和公匙一样，任何人都能够获取，但这个签名*只有用私钥对应的公钥才能解开*，拿到摘要后，再比对原文验证完整性，就可以像签署文件一样证明消息确实是你发的。

上述行为即为**签名和验签**
只要你和网站*互相交换公钥*，就可以用“签名”和“验签”来确认消息的真实性，因为私钥保密，黑客不能伪造签名，就能够保证通信双方的身份

# 数字证书和CA
综合使用对称加密、非对称加密和摘要算法就可以实现机密性、完整性、身份认证和不可否认

最后还有一个重要的问题就是**公匙的信任问题**，因为谁都可以发送公匙，黑客可以伪造公匙，因此我们需要一个手段*判断某个公匙就是某个网站发送*的

需要一个公认的可信第三方，让它作为“信任的起点，递归的终点”，构建起*公钥的信任链。*

这个“第三方”就是我们常说的**CA**（Certificate Authority，证书认证机构）。它就像网络世界里的公安局、教育部、公证中心，具有极高的可信度，由它来给各个公钥签名，用*自身的信誉来保证公钥无法伪造，是可信的*。

## 数字证书的格式和级别
格式：
	包含序列号、用途、颁发者、有效时间等等，把这些打成一个包再签名，完整地证明公钥关联的各种信息

级别：（区别在于可信程度）
	1. DV ： 域名级别的可信，背后是谁不知道（可信级别最低）
	2. OV
	3. EV：经过了法律和审计的严格核查，可以证明网站拥有者的身份（可信级别最高）


## CA的信任链
小一点的CA可以让大CA签名认证，但链条的最后，也就是**Root CA**，就只能自己证明自己了，这个就叫“**自签名证书**”（Self-Signed Certificate）或者“**根证书**”（Root Certificate）。你必须相信，否则整个证书信任链就走不下去了。
![[Pasted image 20220625113418.png]]
有了这个证书体系，操作系统和浏览器都**内置**了各大CA的**根证书**，上网的时候只要服务器发过来它的证书，就可以验证证书里的签名，顺着证书链（Certificate Chain）*一层层地验证，直到找到根证书*，就能够确定证书是可信的，从而里面的公钥也是可信的。

## 证书体系的弱点
证书体系（PKI，Public Key Infrastructure）虽然是目前整个网络世界的安全基础设施，但绝对的安全是不存在的，它也有弱点，还是关键的“**信任**”二字。

1. 如果CA失误或者被欺骗，签发了错误的证书，虽然证书是真的，可它代表的网站却是假的。
2. 还有一种更危险的情况，CA被黑客攻陷，或者CA有恶意，因为它（即根证书）是信任的源头，整个信任链里的所有证书也就都不可信了。

针对第一种，开发出了CRL（证书吊销列表，Certificate revocation list）和OCSP（在线证书状态协议，Online Certificate Status Protocol），*及时废止有问题的证书。*

对于第二种，因为涉及的证书太多，就只能操作系统或者浏览器从根上“下狠手”了，*撤销对CA的信任，列入“黑名单*”，这样它颁发的所有证书就都会被认为是不安全的。

## 小结

1.  摘要算法用来实现完整性，能够为数据生成独一无二的“指纹”，常用的算法是SHA-2；
    
2.  数字签名是私钥对摘要的加密，可以由公钥解密后验证，实现身份认证和不可否认；
    
3.  公钥的分发需要使用数字证书，必须由CA的信任链来验证，否则就是不可信的；
    
4.  作为信任链的源头CA有时也会不可信，解决办法有CRL、OCSP，还有终止信任。