# TLS 1.3的出现
TLS 1.2是2008年提出的，在性能、安全等方面已经跟不上如今的互联网了

TLS1.3在2018年提出，确立了信息安全领域的新标准

TLS的三个改进目标：
**兼容、安全与性能**

# 最大化兼容性
由于1.1、1.2等协议已经出现了很多年，很多应用软件、中间代理（官方称为“MiddleBox”）只认老的记录协议格式，更新改造很困难，甚至是不可行（设备僵化）。

为了保证这些被广泛部署的“老设备”能够继续使用，避免新协议带来的“冲击”，TLS1.3不得不做出妥协，保持现有的记录格式不变，通过“伪装”来实现兼容，使得TLS1.3看上去“像是”TLS1.2。

这要用到一个新的**扩展协议**（Extension Protocol），它有点“补充条款”的意思，通过在记录末尾添加一系列的“扩展字段”来增加新的功能，老版本的TLS不认识它可以直接忽略，这就实现了“后向兼容”。

在记录头的Version字段被兼容性“固定”的情况下，只要是TLS1.3协议，握手的“Hello”消息后面就必须有“**supported_versions**”扩展，它标记了TLS的版本号，使用它就能区分新旧协议。
```
Handshake Protocol: Client Hello
    Version: TLS 1.2 (0x0303)
    Extension: supported_versions (len=11)
        Supported Version: TLS 1.3 (0x0304)
        Supported Version: TLS 1.2 (0x0303)
```


# 强化安全
TLS1.2在十来年的应用中获得了许多宝贵的经验，陆续发现了很多的漏洞和加密算法的弱点，所以TLS1.3就在协议里修补了这些不安全因素。

比如：

-   伪随机数函数由PRF升级为HKDF（HMAC-based Extract-and-Expand Key Derivation Function）；
    
-   明确禁止在记录协议里使用压缩；
    
-   废除了RC4、DES对称加密算法；
    
-   废除了ECB、CBC等传统分组模式；
    
-   废除了MD5、SHA1、SHA-224摘要算法；
    
-   废除了RSA、DH密钥交换算法和许多命名曲线。
    

经过这一番“减肥瘦身”之后，TLS1.3里只保留了AES、ChaCha20对称加密算法，分组模式只能用AEAD的GCM、CCM和Poly1305，摘要算法只能用SHA256、SHA384，密钥交换算法只有ECDHE和DHE，椭圆曲线也被“砍”到只剩P-256和x25519等5种。

现在可选的密码套件只有5种
![[Pasted image 20220627171543.png]]

**废除RSA和DH密钥交换算法的原因**：
 不具有“**前向安全**”（Forward Secrecy）
如果加密系统使用服务器证书里的RSA做密钥交换，一旦私钥泄露或被破解（使用社会工程学或者巨型计算机），那么黑客就能够*使用私钥解密出之前所有报文的“Pre-Master”*，再算出会话密钥，破解所有密文。

ECDHE算法在每次握手时都会生成一对临时的公钥和私钥，每次通信的密钥对都是不同的，也就是“一次一密”，即使黑客花大力气破解了这一次的会话密钥，也只是这次通信被攻击，之前的历史消息不会受到影响，仍然是安全的

# 提升性能
HTTPS建立连接时除了要做TCP握手，还要做TLS握手，在1.2中**会多花两个消息往返（2-RTT）**，可能导致几十毫秒甚至上百毫秒的延迟，在移动网络中延迟还会更严重。

现在因为密码套件大幅度简化，也就没有必要再像以前那样走复杂的协商流程了。TLS1.3压缩了以前的“Hello”协商过程，删除了“Key Exchange”消息，把握手时间**减少到了“1-RTT”**，效率提高了一倍

简化后的流程：
其实具体的做法还是利用了扩展。客户端在“Client Hello”消息里直接用“**supported_groups**”带上支持的曲线，比如P-256、x25519，用“**key_share**”带上曲线对应的客户端公钥参数，用“**signature_algorithms**”带上签名算法。

服务器收到后在这些扩展里选定一个曲线和参数，再用“key_share”扩展返回服务器这边的公钥参数，就实现了双方的密钥交换，后面的流程就和1.2基本一样了。
![[Pasted image 20220627172100.png]]


# TLS 1.3握手分析
一个RTT完成TLS握手
![[7a2bc39fdbb421cf72a01e887e9156db 1.png]]


## 小结

今天我们一起学习了TLS1.3的新特性，用抓包研究了它的握手过程，不过TLS1.3里的内容很多，还有一些特性没有谈到，后面会继续讲。

1.  为了兼容1.1、1.2等“老”协议，TLS1.3会“伪装”成TLS1.2，新特性在“扩展”里实现；
    
2.  1.1、1.2在实践中发现了很多安全隐患，所以TLS1.3大幅度删减了加密算法，只保留了ECDHE、AES、ChaCha20、SHA-2等极少数算法，强化了安全；
    
3.  TLS1.3也简化了握手过程，完全握手只需要一个消息往返，提升了性能。