
# HTTPS影响性能的部分
和HTTP相比，HTTPS的性能可能会差一些，体现在以下两个方面：
1. 每次传输HTTP报文都需要使用**对称加密报文传输**（影响小）
	由于目前流行的AES、ChaCha20性能都很好，还有硬件优化，报文传输的性能损耗可以说是非常地小，小到几乎可以忽略不计了
	
2. 建立连接时需要额外的**TLS非对称加密握手**（影响大）
- 在TCP建连之后，正式数据传输之前，HTTPS比HTTP增加了一个TLS握手的步骤，这个步骤最长可以花费两个消息往返，也就是2-RTT。
- 除了握手消息的网络耗时之外，还会有一些隐式的消耗，如下图所示红色的部分：
	1. 产生用于密匙交换的临时公私匙对（ECDHE）
	2. 验证证书时访问CA获取CRL或者OCSP
	3. 非对称加密计算pre-master

![[Pasted image 20220628171957.png]]

# 优化HTTPS的手段
## 硬件优化
HTTPS是计算密集型
1. 选择**更快的CPU**，最好内建AES加速，这样既可以加速握手，也可以加速传输
2. 选择**SSL加速卡**，加解密时调用其API，让专门的硬件做非对称加解密，缓解CPU的压力
3. “SSL加速卡”也有一些缺点，比如升级慢、支持算法有限，不能灵活定制解决方案等。所以，就出现了第三种硬件加速方式：“**SSL加速服务器**”，用专门的服务器集群来彻底“卸载”TLS握手时的加密解密计算，性能自然要比单纯的“加速卡”要强大的多

## 软件优化
硬件优化不是加强了硬件就立马生效的，还需要相应的软件适配工作
软件优化的方式相对来说更可行一些，性价比高，能够“少花钱，多办事”

- 软件升级
例如*把现在正在使用的软件尽量升级到最新版本*，比如把Linux内核由2.x升级到4.x，把Nginx由1.6升级到1.16，把OpenSSL由1.0.1升级到1.1.0/1.1.1。


## 协议优化
硬件升级或软件升级都是个棘手的问题，有成千上万台各种型号的机器遍布各个机房，逐一升级不仅需要大量人手，而且有较高的风险，可能会影响正常的线上服务。

1. 应当尽量采用TLS1.3，它大幅度简化了握手的过程，完全握手只要1-RTT，而且更加安全。
2. 如果暂时不能升级到1.3，只能用1.2，那么握手时使用的密钥交换协议*应当尽量选用椭圆曲线的ECDHE算法*。它不仅运算速度快，安全性高，还支持“False Start”，能够把握手的消息往返由2-RTT减少到1-RTT，达到与TLS1.3类似的效果。
3. 椭圆曲线也要*选择高性能的曲线*，最好是x25519，次优选择是P-256。对称加密算法方面，也可以选用“AES_128_GCM”，它能比“AES_256_GCM”略快一点点。

## 证书优化
除了密钥交换，握手过程中的证书验证也是一个比较耗时的操作，服务器需要把自己的证书链全发给客户端，然后客户端接收后再逐一验证。

- 优化证书传输过程
服务器的证书可以*选择椭圆曲线（ECDSA）证书而不是RSA证书*，因为224位的ECC相当于2048位的RSA，所以椭圆曲线证书的“个头”要比RSA小很多，即能够节约带宽也能减少客户端的运算量，可谓“一举两得”

- 优化证书验证过程
客户端的证书验证比较复杂，包括以下好几个步骤：
1. 公匙解密验证证书签名
2. 因为证书还有可能会被撤销失效，客户端有时还会再去访问CA，下载CRL或者OCSP数据

**CRL（Certificate revocation list，证书吊销列表**）由CA定期发布，里面是所有被撤销信任的证书序号，查询这个列表就可以知道证书是否有效。

但CRL因为是“定期”发布，就有“时间窗口”的安全隐患，而且随着吊销证书的增多，列表会越来越大，一个CRL经常会上MB。想象一下，每次需要预先下载几M的“无用数据”才能连接网站，实用性实在是太低了。

所以，现在CRL基本上不用了，取而代之的是**OCSP（在线证书状态协议，Online Certificate Status Protocol）**，向CA发送查询请求，让CA返回证书的有效状态。

但OCSP也要多出一次网络请求的消耗，而且还依赖于CA服务器，如果CA服务器很忙，那响应延迟也是等不起的。

于是又出来了一个“补丁”，叫“OCSP Stapling”（**OCSP装订**），它可以让服务器预先访问CA获取OCSP响应，然后在握手时随着证书一起发给客户端，免去了客户端连接CA服务器查询的时间。


## 会话复用
