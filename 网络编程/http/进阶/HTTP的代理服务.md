# HTTP代理的概念
引入HTTP代理后，原来简单的双方通信就变复杂了一些，加入了一个或者多个中间人，但整体上来看，还是一个有顺序关系的链条，而且链条里相邻的两个角色仍然是简单的一对一通信，不会出现越级的情况。

链条的起点还是客户端（也就是浏览器），中间的角色被称为代理服务器（proxy server），链条的终点被称为源服务器（origin server），意思是数据的“源头”“起源”。
![[Pasted image 20220621154311.png]]

# 代理服务
代理服务器本身不生产内容，而是处于中间位置转发上下游的请求和响应，具有双重身份。面向下游的用户时，表现为服务器，代表源服务器响应客户的请求。面向上游的服务器时，表现为客户端，代表客户端发送请求

# 代理的作用和种类
由于代理处在HTTP通信过程的中间位置，相应地就对上屏蔽了真实客户端，对下屏蔽了真实服务器，简单的说就是“**欺上瞒下**”。在这个中间层的“小天地”里就可以做很多的事情，为HTTP协议增加更多的灵活性，实现客户端和服务器的“双赢”

- 反向代理
- 正向代理
- 透明代理
- 匿名代理

# 反向代理的作用
反向代理在传输链路中更靠近源服务器，为源服务器提供代理服务。
-  **负载均衡**
	因为在面向客户端时屏蔽了源服务器，客户端看到的只是代理服务器，源服务器究竟有多少台、是哪些IP地址都不知道。于是代理服务器就可以掌握请求分发的“大权”，决定由后面的哪台服务器来响应请求
	常用的负载均衡算法比如轮询、一致性哈希等等，这些算法的目标都是尽量把外部的流量合理地分散到多台源服务器，提高系统的*整体资源利用率和性能。*
*   **健康检查**：使用“心跳”等机制监控后端服务器，发现有故障就及时“踢出”集群，保证服务高可用；
*   **安全防护**：保护被代理的后端服务器，限制IP地址或流量，抵御网络攻击和过载；
*   **加密卸载**：**对外网使用SSL/TLS加密通信认证**，而在安全的内网不加密，消除加解密成本；
*   **数据过滤**：拦截上下行的数据，任意指定策略修改请求或者响应；
*   **内容缓存**：暂存、复用服务器响应


# 代理相关头字段
代理作为中间人，隐藏了客户端和服务器的信息，但是有时双方需要知道这些信息

1. 代理服务器需要使用**via**字段标记代理身份
Via是一个通用字段，请求头或响应头里都可以出现。每当报文经过一个代理节点，代理服务器就会把*自身的信息追加到字段的末尾*，就像是经手人盖了一个章。

via字段只能让客户端和服务端知道是否经过代理节点，经过几个代理节点，但客户端和服务端仍然不知道对方的具体身份
![[Pasted image 20220622095316.png]]

2. 使用“**X-Forwarded-For**”和“**X-Real-IP**”字段来标识客户端身份
服务器的IP地址应该是保密的，关系到企业的内网安全，所以一般不会让客户端知道。不过反过来，通常服务器需要知道客户端的真实IP地址，方便做访问控制、用户画像、统计分析。

**X-Forwarded-For**：和via字段类似，但是记录的是沿途经过的代理服务器的IP地址，同时包括客户端的IP地址
**X-Real-IP**：只记录客户端的IP地址

![[Pasted image 20220622101202.png]]

# 代理协议
使用上述代理字段能够得到客户端的信息，但是也有缺陷。

通过X-Forwarded-For操作代理信息的缺点：
- 必须要解析HTTP报文头，这对于代理来说成本比较高，原本只需要简单地转发消息就好，而现在却必须要费力解析数据再修改数据，会降低代理的转发性能。
- “X-Forwarded-For”等头必须要修改原始报文，而有些情况下是不允许甚至不可能的（比如使用HTTPS通信被加密）

所以就出现了一个专门的“代理协议”（The PROXY protocol），它由知名的代理软件HAProxy所定义，也是一个“事实标准”，被广泛采用（注意并不是RFC）

在HTTP协议头前又加了一行ASCLL文本，相当于又加了一个头

这一行文本其实非常简单，开头必须是“PROXY”五个大写字母，然后是“TCP4”或者“TCP6”，表示客户端的IP地址类型，再后面是请求方地址、应答方地址、请求方端口号、应答方端口号，最后用一个回车换行（\\r\\n）结束。
```c++
PROXY TCP4 1.1.1.1 2.2.2.2 55555 80\r\n
GET / HTTP/1.1\r\n
Host: www.xxx.com\r\n
\r\n
```

**服务器看到这样的报文，只要解析第一行就可以拿到客户端地址，不需要再去理会后面的HTTP数据