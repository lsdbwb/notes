HTTPS通过引入SSL/TLS在安全上达到了“极致”，但在性能提升方面却是乏善可陈，只优化了握手加密的环节，对于整体的数据传输没有提出更好的改进方案，还只能依赖于“长连接”这种“落后”的技术

HTTP/2主要是大幅提升了HTTP协议的性能

# 兼容HTTP/1
HTTP/2的唯一目标就是提升性能

HTTP/2把HTTP分解成了“语义”和“语法”两个部分，以保持和以前的HTTP协议功能上的兼容
1. HTTP/2在语义上保持不变，与HTTP/1完全一致。比如请求方法、URI、状态码、头字段等概念都保留不变。基于HTTP的上层应用也不需要做任何修改，可以无缝转换到HTTP/2。
2. 在“语义”保持稳定的基础上，HTTP/2在语法上做了重大改动，完全变更了HTTP的**传输格式**

# 头部压缩
HTTP/1没有对Header的传输进行任何优化

1. 报文Header的数据量很大：
报文Header一般会携带“User Agent”，“Cookie”， “Accept”，“Server”等许多固定头字段，多达几百甚至几千字节，但body里有时候只有几十字节（比如GET请求，203/301/304响应）
2. 报文Header很多字段都是冗余的
每个HTTP请求或响应报文的Header里的内容有很多相同重复的，非常浪费

HTTP/2对Header也是采用压缩的方法进行优化。专门开发了**HPACK**压缩算法：在客户端和服务端建立字典，用索引号表示重复的字段（*字典编码*），还采用*哈夫曼编码*来压缩整数和字符串，可以达到50%到90%的高压缩率。


# 二进制格式
HTTP/1使用的是纯文本格式的明文，其优点是“一目了然”，方便修改和调试。缺点是容易出现多义性，比如大小写、空格、回车、多字少字等。程序在处理时必须使用复杂的状态机，解析麻烦，效率低并且容易出错。

HTTP/2全面使用二进制。
二进制里只有0和1。可以严格规定字段大小、顺序、标志位等格式。计算机解析起来没有歧义。实现简单，而且体积小、速度快。

它把*TCP协议的部分特性*挪到了应用层，把原来的“Header+Body”的消息“打散”为数个小片的**二进制“帧”**（Frame），用“HEADERS”帧存放头数据、“DATA”帧存放实体数据。
![[Pasted image 20220630154022.png]]

# 虚拟的流
一个个的消息碎片到了对端后需要被组装起来。

HTTP/2为此定义了一个“**流**”（Stream）的概念，**它是二进制帧的双向传输序列**，同一个消息往返的帧会分配*一个唯一的流ID*。你可以把它想象成是一个虚拟的“数据流”，在里面流动的是一串有先后顺序的数据帧，这些数据帧按照次序组装起来就是HTTP/1里的请求报文和响应报文。

如下图上半部分所示：在“流”的层面上看，消息是一些有序的帧序列
如下图下半部分所示：在“连接”的层面上，消息是乱序收发的帧
![[Pasted image 20220630154346.png]]
多个请求/响应之间没有了顺序关系，不需要排队等待，也就没有所谓的**队头阻塞**问题，降低了延迟，大幅提高了连接的利用率

为了更好地利用连接，加大吞吐量，HTTP/2还添加了一些控制帧来管理虚拟的“流”，实现了优先级和流量控制，这些特性也和TCP协议非常相似

HTTP/2一定程度改变了以往请求-应答的通信模式，服务端也有了**主动推送**（Serve Push）功能。服务器不再是完全被动地响应请求，也可以新建“流”主动向客户端发送消息。。比如，在浏览器刚请求HTML的时候就*提前*把可能会用到的JS、CSS文件发给客户端，减少等待的延迟。


# 强化安全
出于兼容的考虑，HTTP/2延续了HTTP/1的“明文”特点，可以像以前一样使用明文传输数据，不强制使用加密通信，不过格式还是二进制，只是不需要解密。

但由于HTTPS已经是大势所趋，而且主流的浏览器Chrome、Firefox等都公开宣布只支持加密的HTTP/2，所以“事实上”的HTTP/2是**加密**的。也就是说，互联网上通常所能见到的HTTP/2都是使用“https”协议名，跑在TLS上面。

为了区分“加密”和“明文”这两个不同的版本，HTTP/2协议定义了两个字符串标识符：“h2”表示加密的HTTP/2，“h2c”表示明文的HTTP/2，多出的那个字母“c”的意思是“clear text”。

# 协议栈
HTTP/2是建立在HPack、Stream和TLS 1.2之上的
![[Pasted image 20220630155023.png]]

## 小结
今天我简略介绍了HTTP/2的一些重要特性，比较偏重理论，下一次我会用Wireshark抓包，具体讲解HTTP/2的头部压缩、二进制帧和流等特性。

1.  HTTP协议取消了小版本号，所以HTTP/2的正式名字不是2.0；
    
2.  HTTP/2在“语义”上兼容HTTP/1，保留了请求方法、URI等传统概念；
    
3.  HTTP/2使用“HPACK”算法压缩头部信息，消除冗余数据节约带宽；
    
4.  HTTP/2的消息不再是“Header+Body”的形式，而是分散为多个二进制“帧”；
    
5.  HTTP/2使用虚拟的“流”传输消息，解决了困扰多年的“队头阻塞”问题，同时实现了“多路复用”，提高连接的利用率；
    
6.  HTTP/2也增强了安全性，要求至少是TLS1.2，而且禁用了很多不安全的密码套件。